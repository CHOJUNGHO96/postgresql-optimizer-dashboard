name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  claude-review:
    name: Claude ìë™ ì½”ë“œ ë¦¬ë·°
    # Draft PRì€ ì œì™¸
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "base_ref=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "head_ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT

      - name: PR ë³€ê²½ íŒŒì¼ ëª©ë¡
        id: changed-files
        run: |
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          FILES=$(git diff --name-only origin/${{ steps.pr-info.outputs.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$FILES"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: PR diff ìƒì„± (í¬ê¸° ì œí•œ)
        id: diff
        run: |
          git diff origin/${{ steps.pr-info.outputs.base_ref }}...HEAD > pr_diff.txt
          DIFF_SIZE=$(wc -l < pr_diff.txt)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

          # Diffê°€ ë„ˆë¬´ í¬ë©´ ìš”ì•½ë§Œ ìƒì„±
          if [ $DIFF_SIZE -gt 5000 ]; then
            echo "âš ï¸ Diffê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ ($DIFF_SIZE ë¼ì¸). ì£¼ìš” íŒŒì¼ë§Œ ë¦¬ë·°í•©ë‹ˆë‹¤."
            git diff --stat origin/${{ steps.pr-info.outputs.base_ref }}...HEAD > pr_diff_summary.txt
          fi

      - name: Claude APIë¥¼ ì‚¬ìš©í•œ ì½”ë“œ ë¦¬ë·°
        id: claude-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Pythonìœ¼ë¡œ Claude API í˜¸ì¶œ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
          cat > claude_review.py << 'PYTHON_SCRIPT'
          import os
          import json
          import anthropic
          from pathlib import Path

          client = anthropic.Anthropic(api_key=os.environ["ANTHROPIC_API_KEY"])

          # PR ì •ë³´ ì½ê¸°
          pr_number = "${{ steps.pr-info.outputs.pr_number }}"
          pr_title = "${{ steps.pr-info.outputs.pr_title }}"
          pr_author = "${{ steps.pr-info.outputs.pr_author }}"
          diff_size = ${{ steps.diff.outputs.diff_size }}

          # Diff ì½ê¸°
          try:
              with open("pr_diff.txt", "r", encoding="utf-8") as f:
                  pr_diff = f.read()

              # Diffê°€ ë„ˆë¬´ í¬ë©´ ì²« 5000ì¤„ë§Œ
              if diff_size > 5000:
                  pr_diff = "\n".join(pr_diff.split("\n")[:5000])
                  pr_diff += f"\n\n... (ì´ {diff_size}ì¤„ ì¤‘ 5000ì¤„ë§Œ í‘œì‹œ)"
          except Exception as e:
              pr_diff = f"Diffë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}"

          # ë³€ê²½ íŒŒì¼ ëª©ë¡
          changed_files = """${{ steps.changed-files.outputs.files }}"""

          # PR Reviewer Agent í”„ë¡¬í”„íŠ¸ ì½ê¸°
          try:
              with open(".claude/agents/pr-reviewer.md", "r", encoding="utf-8") as f:
                  agent_prompt = f.read()
          except:
              agent_prompt = "ë‹¹ì‹ ì€ ì½”ë“œ ë¦¬ë·° ì „ë¬¸ê°€ì…ë‹ˆë‹¤."

          # Claude API í˜¸ì¶œ
          message = client.messages.create(
              model="claude-sonnet-4-5-20250929",
              max_tokens=8000,
              temperature=0.3,
              system=f"{agent_prompt}\n\ní”„ë¡œì íŠ¸ ë£¨íŠ¸: postgresql-optimizer-dashboard",
              messages=[
                  {
                      "role": "user",
                      "content": f"""ë‹¤ìŒ Pull Requestë¥¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”:

          **PR ì •ë³´:**
          - ë²ˆí˜¸: #{pr_number}
          - ì œëª©: {pr_title}
          - ì‘ì„±ì: @{pr_author}
          - ë³€ê²½ ë¼ì¸ ìˆ˜: {diff_size}

          **ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:**
          ```
          {changed_files}
          ```

          **ë³€ê²½ì‚¬í•­ (Diff):**
          ```diff
          {pr_diff}
          ```

          ---

          ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ìš°ì„ ìˆœìœ„ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:

          1. ğŸ”´ **ë³´ì•ˆ ì·¨ì•½ì ** (Critical) - ìµœìš°ì„ 
             - SQL Injection, XSS, ì¸ì¦/ì¸ê°€ ìš°íšŒ
             - ë¯¼ê° ì •ë³´ ë…¸ì¶œ, CSRF, ì•ˆì „í•˜ì§€ ì•Šì€ ì§ë ¬í™”

          2. ğŸŸ¡ **ì½”ë“œ í’ˆì§ˆ** (High)
             - SOLID ì›ì¹™ ìœ„ë°˜
             - Clean Architecture ê²½ê³„ ìœ„ë°˜
             - ì¤‘ë³µ ì½”ë“œ, ë³µì¡ë„, ë„¤ì´ë°

          3. ğŸŸ¢ **ì„±ëŠ¥ ë¬¸ì œ** (Medium)
             - N+1 query, ë¹„íš¨ìœ¨ì  ì•Œê³ ë¦¬ì¦˜
             - ë¶ˆí•„ìš”í•œ ë Œë”ë§, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜

          4. â„¹ï¸ **í…ŒìŠ¤íŠ¸** (Low)
             - í…ŒìŠ¤íŠ¸ ëˆ„ë½, Edge case

          ë¦¬ë·° í˜•ì‹ì„ ì¤€ìˆ˜í•˜ê³  í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          ê±´ì„¤ì ì´ê³  êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•˜ë˜, ì‚¬ì†Œí•œ ìŠ¤íƒ€ì¼ ë¬¸ì œëŠ” ì œì™¸í•˜ì„¸ìš”.
          """
                  }
              ]
          )

          # ë¦¬ë·° ê²°ê³¼ ì €ì¥
          review_content = message.content[0].text

          # GitHubì— ì½”ë©˜íŠ¸ ì‘ì„±
          with open("review_output.md", "w", encoding="utf-8") as f:
              f.write(review_content)

          print("âœ… Claude ë¦¬ë·° ì™„ë£Œ")
          print(f"ë¦¬ë·° ê¸¸ì´: {len(review_content)} ë¬¸ì")
          PYTHON_SCRIPT

          # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          pip install anthropic requests
          python claude_review.py

      - name: PRì— ë¦¬ë·° ì½”ë©˜íŠ¸ ê²Œì‹œ
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review_output.md', 'utf8');

            // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr-info.outputs.pr_number }},
              body: `## ğŸ¤– Claude ìë™ ì½”ë“œ ë¦¬ë·°

          ${reviewContent}

          ---

          **â„¹ï¸ ì°¸ê³ ì‚¬í•­:**
          - ì´ ë¦¬ë·°ëŠ” Advisory ëª¨ë“œë¡œ, PR ë³‘í•©ì„ ì°¨ë‹¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          - Critical ì´ìŠˆê°€ ë°œê²¬ëœ ê²½ìš°ì—ë„ ìµœì¢… íŒë‹¨ì€ ì‚¬ëŒ ë¦¬ë·°ì–´ê°€ í•©ë‹ˆë‹¤.
          - ë¦¬ë·° í”¼ë“œë°±ì— ëŒ€í•œ ì§ˆë¬¸ì€ íŒ€ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.

          **ë¦¬ë·° ìš°ì„ ìˆœìœ„:** ğŸ”´ ë³´ì•ˆ > ğŸŸ¡ í’ˆì§ˆ > ğŸŸ¢ ì„±ëŠ¥ > â„¹ï¸ í…ŒìŠ¤íŠ¸
          `
            });

      - name: ë¦¬ë·° ì‹¤íŒ¨ ì‹œ ì•ˆë‚´
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr-info.outputs.pr_number }},
              body: `## âš ï¸ Claude ì½”ë“œ ë¦¬ë·° ì‹¤íŒ¨

          ìë™ ì½”ë“œ ë¦¬ë·°ë¥¼ ì‹¤í–‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

          **ê°€ëŠ¥í•œ ì›ì¸:**
          - Anthropic API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ
          - API ìš”ì²­ í•œë„ ì´ˆê³¼
          - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜

          **í•´ê²° ë°©ë²•:**
          1. Repository Settings â†’ Secrets â†’ ANTHROPIC_API_KEY í™•ì¸
          2. [Anthropic Console](https://console.anthropic.com)ì—ì„œ API í‚¤ ìƒíƒœ í™•ì¸
          3. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„

          ì‚¬ëŒ ë¦¬ë·°ì–´ê°€ ìˆ˜ë™ìœ¼ë¡œ ë¦¬ë·°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
          `
            });
